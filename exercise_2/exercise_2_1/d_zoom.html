<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Zoom functionality</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
      text {
        font-family: "Yanone Kaffeesatz", sans-serif;
        font-size: 7pt;
      }
      .domain {
        opacity: 0;
      }
      .y-axis line,
      .x-axis line {
        stroke-width: 0.25;
        stroke: rgba(114, 138, 74, 0.5);
      }
      .label {
        font-size: 9pt;
        text-anchor: middle;
      }
    </style>
  </head>
  <body>
    <svg width="100%" height="100%" viewBox="0 0 500 300"></svg>
  </body>
  <script>
    d3.selection.prototype.moveToFront = function () {
      return this.each(function () {
        this.parentNode.appendChild(this);
      });
    };

    const w = 500,
      h = 300,
      marginH = 40,
      marginW = 50,
      circMin = 2,
      circMax = 3,
      infoTextSize = 4;

    var maxPop = 0;
    var minPop = Number.MAX_SAFE_INTEGER;

    const scaleX = d3.scaleLinear().range([marginW, w - marginW]);
    const scaleY = d3.scaleLog().range([h - marginH, marginH]);
    const color = d3.scaleOrdinal(d3.schemeDark2);

    const axisX = d3
      .axisBottom(scaleX)
      .tickSize(h - marginH * 2 + 10)
      .tickPadding(2);
    const axisY = d3
      .axisLeft(scaleY)
      .tickSize(w - marginW * 2 + 10)
      .tickPadding(2)
      .ticks(8, ",");

    const data = {
      continents: new Set(),
    };

    d3.csv("/exercise_2_1/data/UnRegionsGdp.csv", function (row) {
      if (row.HDI_2017 > 0 && row.GDP_2017 > 0) {
        data.continents.add(row.Continent);
        maxPop = row.Pop_2016 > maxPop ? row.Pop_2016 : maxPop;
        minPop = row.Pop_2016 < minPop ? row.Pop_2016 : minPop;
        return {
          name: row.Country,
          code: row.Code,
          continent: row.Continent,
          population: +row.Pop_2016,
          hdi: +row.HDI_2017,
          gdp: +row.GDP_2017,
        };
      }
    }).then(function (dataset) {
      data.continents = [...data.continents].sort((a, b) => d3.ascending(a, b));
      data.countries = dataset;
      scaleY.domain(d3.extent(dataset, (d) => d.gdp));
      scaleX.domain(d3.extent(dataset, (d) => d.hdi));

      draw();
      drawLegend();
    });

    function draw() {
      const xG = d3
        .select("svg")
        .append("g")
        .attr("class", "x-axis")
        .attr("transform", `translate(${[0, marginH]})`)
        .call(axisX);

      const yG = d3
        .select("svg")
        .append("g")
        .attr("class", "y-axis")
        .attr("transform", `translate(${[w - marginW, 0]})`)
        .call(axisY);

      d3.select("svg")
        .append("text")
        .attr("class", "label")
        .text("Human Development Index (HDI)")
        .attr("transform", `translate(${[w / 2, h - 3]})`);
      d3.select("svg")
        .append("text")
        .attr("class", "label")
        .text("Annual GDP per capita (USD)")
        .attr("transform", `translate(${[3, h / 2]}) rotate(90)`);

      const scaleRadius = d3
        .scaleLinear()
        .domain([minPop, maxPop])
        .range([circMax, circMin]);

      const scatter = d3
        .select("svg")
        .selectAll("circle")
        .data(data.countries)
        .enter()
        .append("circle")
        .attr("r", (d) => scaleRadius(d.population))
        .attr("cx", (d) => scaleX(d.hdi))
        .attr("cy", (d) => scaleY(d.gdp))
        .style("fill", (d) => color(d.continent));

      const zoom = d3
        .zoom()
        .scaleExtent([0.5, 20])
        .extent([
          [0, 0],
          [w, h],
        ])
        .on("zoom", updateScatterPlot);

      d3.select("svg")
        .append("rect")
        .attr("width", w)
        .attr("height", h)
        .style("fill", "none")
        .style("pointer-events", "all")
        .attr("transform", `translate(${[0, 0]})`)
        .call(zoom);

      function updateScatterPlot() {
        const newScaleX = d3.event.transform.rescaleX(scaleX);
        const newScaleY = d3.event.transform.rescaleY(scaleY);

        aX = d3
          .axisBottom(newScaleX)
          .tickSize(h - marginH * 2 + 10)
          .tickPadding(2);
        aY = d3
          .axisLeft(newScaleY)
          .tickSize(w - marginW * 2 + 10)
          .tickPadding(2)
          .ticks(8, ",");

        xG.call(aX);
        yG.call(aY);

        d3.select("svg")
          .selectAll("circle")
          .attr("cx", (d) => newScaleX(d.hdi) - 20)
          .attr("cy", (d) => newScaleY(d.gdp) - 20);
      }
    }

    function drawLegend() {
      const legend = d3
        .select("svg")
        .append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${[85, 50]})`);

      legend
        .selectAll("g.item")
        .data(data.continents)
        .join("g")
        .attr("class", "item")
        .each(function (d, i) {
          d3.select(this)
            .append("rect")
            .attr("y", i * 10)
            .attr("height", 8)
            .attr("width", 20)
            .style("fill", color(d));

          d3.select(this)
            .append("text")
            .attr("y", i * 10 + 7)
            .attr("x", 24)
            .text(d);
        });
    }
  </script>
</html>
