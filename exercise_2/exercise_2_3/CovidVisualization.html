<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Covid-19 Dataset</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
      text {
        font-family: "Yanone Kaffeesatz", sans-serif;
        font-size: 7pt;
      }
      .label {
        font-size: 20pt;
        text-anchor: middle;
        fill: red;
      }
    </style>
  </head>
  <body>
    <svg width="100%" height="100%" viewBox="0 0 1200 600"></svg>
  </body>
  <script>
    function hashCode(s) {
      let h = 0;
      for (let i = 0; i < s.length; i++)
        h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;
      return h;
    }

    covid_data = {
      keys: {},
      subgroups: {},
      data: {},
    };

    d3.csv("/exercise_2_3/data/owid-covid-data.csv", function (row) {
      return {
        key: row.iso_code,
        key_hash: hashCode(row.iso_code),
        location: row.location,
        date: row.date,
        total_cases: +row.total_cases,
      };
    }).then(function (d) {
      covid_data.data = d;
      covid_data.subgroups = d.columns.slice(1);
      covid_data.keys = d3
        .map(d, function (d) {
          return d.key;
        })
        .keys()
        .sort(function (a, b) {
          return d3.ascending(a, b);
        });
      draw();
    });

    // Retrieve data for an iso_code
    function getData(key) {
      return covid_data.data.filter((entry) => entry.key === key);
    }

    // Retrieve array containing values of single column
    function getFilteredColumnData(key, column) {
      return getData(key).map((entry) => entry[column]);
    }

    function draw() {
      var margin = { top: 50, right: 0, bottom: 10, left: 100, circle: 20 },
        w = 1200 - margin.left - margin.right,
        h = 600 - margin.top - margin.bottom;

      d3.select("svg")
        .append("text")
        .attr("class", "label")
        .text("Unfinished! Shows total cases of Germany (cumulative)")
        .attr("transform", `translate(${[w / 2, margin.top]})`)
        .style("font-size", 50);

      const search = d3
        .select("svg")
        .append("g")
        .attr("transform", `translate(${[0, 0]})`);

      search
        .selectAll("g.item")
        .data(covid_data.keys)
        .join("g")
        .attr("class", "item")
        .each(function (d, i) {
          d3.select(this)
            .append("rect")
            .attr("y", i * 10)
            .attr("height", 8)
            .attr("width", 20);

          d3.select(this)
            .append("text")
            .attr("y", i * 10 + 7)
            .attr("x", 24)
            .text(d);
        });

      var parseDate = d3.timeParse("%Y-%m-%d");

      const dates = getFilteredColumnData("DEU", "date").map(parseDate);
      const total_cases = getFilteredColumnData("DEU", "total_cases");

      const scaleX = d3
        .scaleTime()
        .range([(w + margin.left + margin.right) / 3, w])
        .domain([dates[0], dates[dates.length - 1]]);

      const scaleY = d3
        .scaleLinear()
        .range([h, margin.top + 50])
        .domain([0, d3.max(total_cases)]);

      const axisX = d3.axisBottom(scaleX);
      const axisY = d3.axisLeft(scaleY);

      const xG = d3
        .select("svg")
        .append("g")
        .attr("id", "x-axis")
        .attr("transform", `translate(${[0, h]})`)
        .call(axisX);

      const yG = d3
        .select("svg")
        .append("g")
        .attr("id", "y-axis")
        .attr(
          "transform",
          `translate(${[(w + margin.left + margin.right) / 3, 0]})`
        )
        .call(axisY);

      const graph = d3
        .select("svg")
        .append("path")
        .datum(getData("DEU"))
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5)
        .attr(
          "d",
          d3
            .line()
            .x(function (d) {
              return scaleX(parseDate(d.date));
            })
            .y(function (d) {
              return scaleY(d.total_cases);
            })
        );
    }
  </script>
</html>
