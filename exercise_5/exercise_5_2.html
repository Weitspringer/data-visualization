<!DOCTYPE html>
<html lang="eng">

<head>
    <meta charset="UTF-8" />
    <title>International Migration Flows 2017</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        body {
            font: 10px sans-serif;
            font-family: "Ubuntu", sans-serif;
            position: relative;
        }

        .title {
            font-family: "Ubuntu", sans-serif;
            font-size: 20pt;
            font-weight: 300;
        }
    </style>
</head>

<body>
    <div id="chart"></div>
</body>
<script>
    // Dimensions with margins
    let margin = { top: 60, right: 30, bottom: 0, left: 35 },
        width = 1200 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;

    // Define variables
    const numberDestinations = 30;
    const nodeInfo = ["Destination", "Population", "Total", "Code"];
    let links = [];
    let nodes = [];
    var matrix = [];

    // Read data and process it afterwards
    d3.csv("/data/MigrationFlow.csv", function (row) {
        //--- Additional calculations ---//
        return row;
    }).then(function (data) {
        //--- Preprocessing ---//
        data.forEach(destFlow => {
            // Create link entries
            Object.entries(destFlow).forEach(entry => {
                const [key, value] = entry;
                if (value != "" && !nodeInfo.includes(key)) {
                    links.push({ source: key, target: destFlow.Destination, value: value });
                }
            });
            // Create node entry
            nodes.push({ id: destFlow.Destination, code: destFlow.Code, totalImmigration: parseInt(destFlow.Total), countryPopulation: parseInt(destFlow.Population) });
        });
        // Sort nodes regarding immigration data
        nodes.sort(function (a, b) {
            return a.totalImmigration < b.totalImmigration;
        });
        // Trim the data
        mostSignificantTargetNodes = nodes.slice(0, numberDestinations).map(node => node.id);
        data.forEach(destFlow => {
            if (mostSignificantTargetNodes.includes(destFlow.Destination)) {
                matrix.push(Object.keys(destFlow).filter(key => mostSignificantTargetNodes.includes(key)).map(key => +destFlow[key]));
            }
        })

        var res = d3
            .chord()
            .padAngle(0.05)
            .sortSubgroups(d3.descending)
            (matrix)

        //--- Drawing ---//
        const colorGroup = d3.scaleSequential().domain([0, mostSignificantTargetNodes.length]).interpolator(d3.interpolateSinebow)

        // Insert svg and group
        var svg = d3
            .select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        // Print the title
        svg
            .append("text")
            .attr("class", "title")
            .attr("x", width / 2)
            .attr("y", 0)
            .style("text-anchor", "middle")
            .text("Migration flows in 2017")
            .attr("pointer-events", "none")

        var arc = d3.arc()
            .innerRadius(300)
            .outerRadius(310)

        var labelArc = d3.arc()
            .innerRadius(340)
            .outerRadius(350)
        
        var chord = d3.chord()
            .padAngle(0.05)
            .sortSubgroups(d3.descending)
        
        var ribbon = d3.ribbon()
            .radius(300)
        
        var g = svg.append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
            .datum(res)
        
        var groups = g.append("g")
            .attr("class", "groups")
        
        var group = groups.selectAll("g")
            .data(d => d.groups)
            .enter()
            .append("g")
            .attr("class", "group")
        
        var arcSvg = group.append("path")
            .attr("class", "arc")
            .attr("d", arc)
            .style("fill", function (d) { return colorGroup(d.index) })
            .style("stroke", "black")
        
        group.append("text")
            .attr("dy", ".35em")
            .attr("transform", function (d) {
                return "translate("
                    + labelArc
                        .startAngle(d.startAngle)
                        .endAngle(d.endAngle)
                        .centroid() + ")"
            })
            .attr("class", "group-label")
            .attr("text-anchor", "middle")
            .text(function (d) { return mostSignificantTargetNodes[d.index] })

        var ribbons = g.append("g")
            .attr("class", "ribbons")
            .selectAll("path")
            .data(function (d) { return d })
            .enter()
            .append("path")
            .attr("d", ribbon)
            .style("fill", d => colorGroup(d.source.index))
            .style("opacity", 0.7)
    });
</script>

</html>